<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>TestTask5</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.0/jquery.min.js"></script>
    <link rel="stylesheet" type="text/css" href="/styles.css"/>
    <link rel="stylesheet" type="text/css" href="/scripts/calendar/tcal.css"/>
    <script src="scripts/calendar/tcal.js"></script>
</head>

<body>
<div>
    <h1>Список товаров</h1>
</div>

<button class="edit-delete-button" onclick="refresh()">Обновить</button>

<div id="mainTable"></div>

<!--<span id="test">test</span>-->

<button class="open-button" onclick="openForm()">Добавить продукт</button>

<div id="createDIV" class="form-popup">
    <form id="CreateForm" method="post" action="" class="form-container">
        <!--accept-charset="utf-8"-->
        <!--        onsubmit="createOrUpdate();"-->
        <p id="CreateFormHeader"><b>Добавить продукт</b></p>

        <label for="inputID">Идентификатор</label>
        <input type="text" id="inputID" name="id" readonly="readonly" autocomplete="off">
        <br>
        <label for="inputName">Название</label>
        <input type="text" id="inputName" name="name" maxlength="512" autocomplete="off" required>
        <br>
        <label for="inputDescription">Описание</label>
        <textarea type="text" id="inputDescription" name="description" maxlength="1024" autocomplete="off"
                  required></textarea>
        <br>
        <label for="inputCreate_date">Добавлен в базу</label>
        <input type="text" id="inputCreate_date" name="create_date" class="tcal" readonly="readonly" autocomplete="off"
               required>
        <br>
        <label for="inputPlace_storage">Ячейка хранения</label>
        <input type="text" id="inputPlace_storage" name="place_storage" autocomplete="off" required>
        <br>
        <label for="inputReserved">Зарезервирован</label>
        <input type="checkbox" id="inputReserved" name="reserved">
        <br>
        <button type="submit" id="submitButton" class="btn">ОК</button>
        <br>
        <button type="button" class="btn cancel" onclick="closeForm()">Отмена</button>
    </form>
</div>

<div id="result_form"></div>

<script>
    $(document).ready(function () {
        $("#submitButton").click(
            function () {
                var operationUrl = "/create";

                if (document.getElementById("CreateFormHeader").innerText === "Изменить продукт")
                    operationUrl = "/update";

                $.ajax({
                    url: operationUrl,
                    type: "POST",
                    dataType: "html",
                    data: $("#CreateForm").serialize(),
                    success: function (response) {
                        result = $.parseJSON(response);
                        $('#result_form').html('Данные отправлены успешно');
                        refresh();
                        closeForm();
                    },
                    error: function (response) {
                        $('#result_form').html('Ошибка. Данные не отправлены.');
                    }
                });

                return false;
            }
        );
    });

</script>

<script>
    var xmlHttp = new XMLHttpRequest();

    //TODO: cross-browser XMLHttpRequest

    function refresh() {
        xmlHttp.open("GET", "/refresh", true);
        xmlHttp.send();
        xmlHttp.onreadystatechange = function () {
            if (this.readyState == 4 && this.status == 200) {
                var serverRequest = JSON.parse(this.responseText);
                var tableContent = "<table border=\"1\"><tr><th>Идентификатор</th><th>Название</th><th>Описание</th><th>Добавлен в базу</th><th>Ячейка хранения</th><th>Зарезервирован</th><th>Изменить запись</th></tr>"
                var isChecked = "";

                for (var x in serverRequest) {

                    if (serverRequest[x].reserved)
                        isChecked = "Да";

                    tableContent += "<tr><td>" +
                        serverRequest[x].id + "</td><td>" +
                        serverRequest[x].name + "</td><td>" +
                        serverRequest[x].description + "</td><td>" +
                        formatDate(serverRequest[x].create_date) + "</td><td>" +
                        serverRequest[x].place_storage + "</td><td>" +
                        isChecked + "</td><td><button name=" +
                        serverRequest[x].id + " class=\"edit-delete-button\" onclick='return askProductData(this);'>Редактировать</button>&nbsp<button name=" +
                        serverRequest[x].id + " class=\"edit-delete-button\" onclick='return deleteProduct(this);'>Удалить</button></td></tr>";
                }
                tableContent += "</table>";
                document.getElementById("mainTable").innerHTML = tableContent;
            }
        };
    }

    function askProductData(Element) {
        xmlHttp.open("POST", "/update", true);
        xmlHttp.send(Element.name + "\n");

        xmlHttp.onreadystatechange = function () {
            if (this.readyState == 4 && this.status == 200) {
                var serverRequest = JSON.parse(this.responseText);

                document.getElementById("inputID").setAttribute("value", serverRequest.id);
                document.getElementById("inputName").setAttribute("value", serverRequest.name);
                document.getElementById("inputDescription").innerText = serverRequest.description;
                document.getElementById("inputCreate_date").setAttribute("value", formatDate(serverRequest.create_date));
                document.getElementById("inputPlace_storage").setAttribute("value", serverRequest.place_storage);
                if (serverRequest.reserved)
                    document.getElementById("inputReserved").setAttribute("checked", "");

                document.getElementById("CreateFormHeader").innerText = "Изменить продукт";
                openForm();
            }
        };
    }

    function formatDate(dateMills) {
        var date = new Date(+(dateMills));
        var day = "" + date.getDate();
        if (date.getDate() < 10)
            day = "0" + date.getDate();

        var month = "" + (date.getMonth() + 1);
        if ((date.getMonth() + 1) < 10)
            day = "0" + (date.getMonth() + 1);

        return day + "-" + month + "-" + date.getFullYear();
    }

    function deleteProduct(Element) {
        xmlHttp.open("POST", "/delete", true);
        xmlHttp.send(Element.name);

        xmlHttp.onreadystatechange = function () {
            if (this.readyState == 4 && this.status == 200) {
                // if ((this.responseText) == "true"
                refresh();
            }
        };
    }

    //Управление формой товара
    function openForm() {
        document.getElementById("createDIV").style.display = "block";
    }

    function closeForm() {
        document.getElementById("createDIV").style.display = "none";

        document.getElementById("inputID").setAttribute("value", "");
        document.getElementById("inputName").setAttribute("value", "");
        document.getElementById("inputDescription").innerText = "";
        document.getElementById("inputCreate_date").setAttribute("value", "");
        document.getElementById("inputPlace_storage").setAttribute("value", "");
        document.getElementById("inputReserved").setAttribute("value", "");

        document.getElementById("CreateFormHeader").innerText = "Добавить продукт";
    }

    function validateForm() {
        // // document.getElementById("test").innerText = document.getElementById("inputPlace_storage").getAttribute("value");
        // if (!isNaN(+document.getElementById("inputPlace_storage").getAttribute("value")))
        //     return true;
        // else {
        //     alert("Номер ячейки хранения должен быть положительным числом");
        //     // document.getElementById("inputPlace_storage").setAttribute("value", "")
        //     return false;
        // }

    }

    // Маска даты
    // $(function () {
    //     $('input#inputCreate_date').mask('99-99-9999');
    // });

    refresh();
</script>
</body>
</html>